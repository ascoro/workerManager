/*! workerManager - v0.1.0 - 2013-07-21
* Copyright (c) 2013 Albert Serra; Licensed  */
var workerManager=function(a){a=a||{};var b=this,c=a.functions||[],d=[],e=[],f=a.numWorkers||4,g=function(){var a=new coroWorker({callback:i,functions:c});return a.count=e.length,e.push(a),a},h=function(){for(var a=0;e[a];a++)if(0==e[a].activeTasks)return e[a]};b.execute=function(a,b,c){var e=Math.floor(1e11*Math.random()),f={name:a,params:b,callbackHash:e,timestamp:new Date,callback:c};d.push(f),i()};var i=function(){for(;d[0];){var a=h();if(!a)break;a.executeTask(d.pop())}},j=function(){for(var a=0;f>a;a++)g()};b.printStatistics=function(){for(var a=0;e[a];a++)console.log(e[a].getStatistics())},j()},coroWorker=function(a){var b,c=this,d=a.functions,e=[];c.activeTasks=0,c.timeSpend=0,c.totalTasks=0,c.getStatistics=function(){return"Worker "+c.count+" has processed "+c.totalTasks+" tasks in "+c.timeSpend+" milliseconds"},this.executeTask=function(a){h(a),b.postMessage(JSON.stringify(a))};var f=function(a){for(var b=a.length,c="",d=0;b>d;d++){var e=a[d];c+='case "'+e.name+'":'+e.code+";break;"}return URL.createObjectURL(new window.Blob(["self.addEventListener('message', function(e) { var o = JSON.parse(e.data);var params = o.params; var result={success:true}; switch(o.name){"+c+"default:result={success:false,message:'Not implemented'};break;}; result.callbackHash=o.callbackHash;self.postMessage(JSON.stringify(result)); }, false);"],{type:"text/javascript"}))},g=function(a,b){var d=b.timestamp.getTime()-a.timestamp.getTime();c.timeSpend+=d,c.activeTasks--,console.log("Return task "+a.callbackHash+" to function "+a.name+" from worker num "+c.count)},h=function(a){e[a.callbackHash]=a,c.activeTasks++,c.totalTasks++,console.log("Init task "+a.callbackHash+" to function "+a.name+" from worker num "+c.count)},i=function(b){b.timestamp=new Date;var c=e[b.callbackHash];g(c,b),setTimeout(a.callback,0),setTimeout(function(){c.callback({result:b,task:c})},0)},j=function(){b=new Worker(f(d)),b.addEventListener("message",function(a){i(JSON.parse(a.data))},!1)};j()};